{% extends "base.html" %}

{% block content %}
<div class="execution-page">
    <h2>测试执行</h2>

    <div class="execution-form">
        <div class="form-group">
            <label for="testProject">选择测试项目:</label>
            <select id="testProject" required>
                <option value="">请选择测试项目</option>
                <option value="API">API接口</option>
                <option value="android_app">Android App</option>
                <option value="Windows">Windows应用</option>
            </select>
            <div class="form-hint">选择要执行的测试项目</div>
        </div>

        <div class="form-group">
            <label for="testPlan">选择测试计划:</label>
            <select id="testPlan" required disabled>
                <option value="">请先选择测试项目</option>
            </select>
            <div class="form-hint">选择要执行的测试计划</div>
        </div>

        <div class="button-group">
            <button id="executeBtn" class="btn btn-primary">开始执行测试</button>
            <button id="clearLogBtn" class="btn btn-secondary">清空日志</button>
        </div>
    </div>

    <div class="execution-info">
        <h3>执行信息</h3>
        <div class="info-grid">
            <div class="info-item">
                <label>当前状态:</label>
                <span id="executionStatus" class="status-waiting">等待执行</span>
            </div>
            <div class="info-item">
                <label>执行的命令:</label>
                <span id="executionCommand" class="command-text">-</span>
            </div>
            <div class="info-item">
                <label>开始时间:</label>
                <span id="startTime">-</span>
            </div>
            <div class="info-item">
                <label>测试报告:</label>
                <span id="reportLink">-</span>
            </div>
        </div>
    </div>

    <div class="execution-log">
        <div class="log-header">
            <h3>执行日志 (log_record() 记录)</h3>
            <div class="log-controls">
                <button id="autoScrollBtn" class="btn btn-small btn-active">自动滚动</button>
                <button id="copyLogBtn" class="btn btn-small">复制日志</button>
                <button id="refreshLogBtn" class="btn btn-small">刷新日志</button>
            </div>
        </div>
        <div id="logOutput" class="log-output">
            <div class="log-placeholder">日志将在此处显示...</div>
        </div>
    </div>
</div>

<script>
// 测试项目与测试计划的映射
const testPlans = {
    'API': [
        { value: 'smoke', label: '冒烟测试', command: 'pytest tests/API/test_entrance.py::test_execute_smoke_cases' },
        { value: 'all_fun', label: '全功能测试', command: 'pytest tests/API/test_entrance.py::test_execute_all_fun' },
        { value: 'user_service', label: '用户模块测试', command: 'pytest tests/API/test_entrance.py::test_user_service' },
        { value: 'order_service', label: '订单模块测试', command: 'pytest tests/API/test_entrance.py::test_order_service' }
    ],
    'android_app': [
        { value: 'smoke', label: '冒烟测试', command: 'pytest tests/API/test_entrance.py::test_execute_smoke_cases' },
        { value: 'bookstore', label: '书城', command: 'pytest tests/Android/test_entrance.py::test_bookstore' },
        { value: 'bookshelf', label: '书架', command: 'pytest tests/Android/test_entrance.py::test_bookshelf' },
        { value: 'user_center', label: '我的', command: 'pytest tests/Android/test_entrance.py::test_user_center' }
    ],
    'Windows': [
        { value: 'bidding_information', label: '招标信息', command: 'pytest tests/Windows/test_entrance.py::test_bidding_information' },
        { value: 'editing_file', label: '文件编辑', command: 'pytest tests/Windows/test_entrance.py::test_editing_file' },
        { value: 'save_file', label: '生成文件', command: 'pytest tests/Windows/test_entrance.py::test_save_file' }
    ]
};

// 全局变量
let currentTimestamp = null;
let logPollingInterval = null;
let autoScrollEnabled = true;
let testCompleted = false;

// 初始化事件监听
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('testProject').addEventListener('change', updateTestPlans);
    document.getElementById('executeBtn').addEventListener('click', executeTests);
    document.getElementById('clearLogBtn').addEventListener('click', clearLog);
    document.getElementById('autoScrollBtn').addEventListener('click', toggleAutoScroll);
    document.getElementById('copyLogBtn').addEventListener('click', copyLog);
    document.getElementById('refreshLogBtn').addEventListener('click', manualRefreshLog);
});

// 更新测试计划选项
function updateTestPlans() {
    const testProject = document.getElementById('testProject').value;
    const testPlanSelect = document.getElementById('testPlan');

    // 清空现有选项
    testPlanSelect.innerHTML = '';

    if (!testProject) {
        testPlanSelect.disabled = true;
        testPlanSelect.innerHTML = '<option value="">请先选择测试项目</option>';
        return;
    }

    // 添加新选项
    const plans = testPlans[testProject];
    if (plans && plans.length > 0) {
        testPlanSelect.disabled = false;
        testPlanSelect.innerHTML = '<option value="">请选择测试计划</option>';

        plans.forEach(plan => {
            const option = document.createElement('option');
            option.value = plan.value;
            option.textContent = plan.label;
            testPlanSelect.appendChild(option);
        });
    } else {
        testPlanSelect.disabled = true;
        testPlanSelect.innerHTML = '<option value="">该项目暂无测试计划</option>';
    }
}

// 重置执行信息
function resetExecutionInfo() {
    document.getElementById('executionStatus').textContent = '等待执行';
    document.getElementById('executionStatus').className = 'status-waiting';
    document.getElementById('executionCommand').textContent = '-';
    document.getElementById('executionCommand').className = 'command-text';
    document.getElementById('startTime').textContent = '-';
    document.getElementById('reportLink').textContent = '-';
}

// 执行测试
async function executeTests() {
    const testProject = document.getElementById('testProject').value;
    const testPlan = document.getElementById('testPlan').value;
    const executeBtn = document.getElementById('executeBtn');

    if (!testProject) {
        alert('请选择测试项目');
        return;
    }

    if (!testPlan) {
        alert('请选择测试计划');
        return;
    }

    // 重置状态
    testCompleted = false;

    // 停止之前的日志轮询（如果有）
    if (logPollingInterval) {
        clearInterval(logPollingInterval);
        logPollingInterval = null;
    }

    // 更新UI状态
    executeBtn.disabled = true;
    executeBtn.textContent = '执行中...';

    // 重置执行信息
    resetExecutionInfo();

    // 获取执行命令
    const selectedPlan = testPlans[testProject].find(plan => plan.value === testPlan);
    const command = selectedPlan ? selectedPlan.command : `pytest -m ${testPlan}`;

    // 更新执行信息
    const startTime = new Date().toLocaleString();
    updateExecutionInfo('正在执行', command, startTime, '-');

    // 清空日志
    clearLog();
    addLogEntry(`开始执行测试项目: ${testProject}`);
    addLogEntry(`开始执行测试计划: ${testPlan}`);
    addLogEntry(`执行命令: ${command}`);
    addLogEntry(`开始时间: ${startTime}`);
    addLogEntry('='.repeat(50));

    try {
        const response = await fetch('/api/execute-test-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                test_project: testProject,
                test_plan: testPlan
            })
        });

        const data = await response.json();

        if (data.success) {
            currentTimestamp = data.timestamp;
            addLogEntry('测试已开始在后台执行，正在获取日志...');

            // 开始轮询日志
            startLogPolling();
        } else {
            addLogEntry(`执行失败: ${data.message}`, 'error');
            resetUI();
        }
    } catch (error) {
        console.error('执行测试失败:', error);
        addLogEntry(`执行失败: ${error.message}`, 'error');
        resetUI();
    }
}

// 开始轮询日志
function startLogPolling() {
    if (logPollingInterval) {
        clearInterval(logPollingInterval);
    }

    logPollingInterval = setInterval(fetchLog, 3000); // 每3秒获取一次日志
}

// 获取日志内容
async function fetchLog() {
    if (!currentTimestamp) return;

    try {
        const response = await fetch(`/api/execution-log?timestamp=${encodeURIComponent(currentTimestamp)}`);
        const data = await response.json();

        if (data.success) {
            // 清空日志并显示新内容
            const logOutput = document.getElementById('logOutput');

            // 移除placeholder
            if (logOutput.querySelector('.log-placeholder')) {
                logOutput.innerHTML = '';
            }

            if (data.log_content) {
                // 解析日志内容，按行处理
                const lines = data.log_content.split('\n');
                const currentContent = logOutput.innerHTML;

                // 只添加新行（简单的去重，实际可能需要更复杂的逻辑）
                lines.forEach(line => {
                    if (line.trim() && !currentContent.includes(line)) {
                        addLogEntry(line);
                    }
                });

                // 自动滚动到底部
                if (autoScrollEnabled) {
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            }

            // 检查测试是否完成
            if (data.completed) {
                testCompleted = true;
                const testProject = document.getElementById('testProject').value;
                const testPlan = document.getElementById('testPlan').value;
                const selectedPlan = testPlans[testProject].find(plan => plan.value === testPlan);
                const command = selectedPlan ? selectedPlan.command : `pytest -m ${testPlan}`;

                updateExecutionInfo('执行完成', command,
                                  document.getElementById('startTime').textContent,
                                  data.report_url ? '可用' : '生成中');

                // 显示报告链接
                if (data.report_url) {
                    showReportLink(data.report_url);
                }

                // 停止轮询
                if (logPollingInterval) {
                    clearInterval(logPollingInterval);
                    logPollingInterval = null;
                }

                // 重置UI
                resetUI();

                addLogEntry('='.repeat(50));
                addLogEntry('测试执行完成！');
                if (data.report_url) {
                    addLogEntry(`测试报告已生成: ${data.report_url}`, 'success');
                }
            }
        }
    } catch (error) {
        console.error('获取日志失败:', error);
    }
}

// 手动刷新日志
function manualRefreshLog() {
    if (currentTimestamp) {
        fetchLog();
        showMessage('日志已刷新', 'info');
    }
}

// 显示报告链接
function showReportLink(reportUrl) {
    const reportLinkSpan = document.getElementById('reportLink');
    reportLinkSpan.innerHTML = `<a href="${reportUrl}" target="_blank" class="report-link">查看测试报告</a>`;
}

// 清空日志
function clearLog() {
    const logOutput = document.getElementById('logOutput');
    logOutput.innerHTML = '<div class="log-placeholder">日志已清空</div>';
}

// 切换自动滚动
function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const btn = document.getElementById('autoScrollBtn');

    if (autoScrollEnabled) {
        btn.classList.add('btn-active');
        btn.textContent = '自动滚动 ✓';

        // 立即滚动到底部
        const logOutput = document.getElementById('logOutput');
        logOutput.scrollTop = logOutput.scrollHeight;
    } else {
        btn.classList.remove('btn-active');
        btn.textContent = '自动滚动';
    }
}

// 复制日志
function copyLog() {
    const logOutput = document.getElementById('logOutput');
    const text = logOutput.textContent || logOutput.innerText;

    navigator.clipboard.writeText(text).then(() => {
        showMessage('日志已复制到剪贴板', 'success');
    }).catch(err => {
        console.error('复制失败:', err);
        showMessage('复制失败', 'error');
    });
}

// 添加日志条目
function addLogEntry(message, type = 'info') {
    const logOutput = document.getElementById('logOutput');

    // 移除placeholder
    if (logOutput.querySelector('.log-placeholder')) {
        logOutput.innerHTML = '';
    }

    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;

    // 处理日志格式（根据log_record的格式）
    let formattedMessage = message;

    // 尝试解析日志格式 [时间][级别]<名称> 内容:消息
    const logRegex = /^\[(.*?)\]\[(.*?)\]<(.*?)>\s*(.*?):(.*)$/;
    const match = message.match(logRegex);

    if (match) {
        const [, time, level, name, prefix, content] = match;
        formattedMessage = `
            <span class="log-time">[${time}]</span>
            <span class="log-level level-${level.toLowerCase()}">[${level}]</span>
            <span class="log-name">&lt;${name}&gt;</span>
            <span class="log-content">${content}</span>
        `;
        logEntry.innerHTML = formattedMessage;
    } else {
        logEntry.textContent = message;
    }

    logOutput.appendChild(logEntry);
}

// 更新执行信息
function updateExecutionInfo(status, command, startTime, reportStatus) {
    document.getElementById('executionStatus').textContent = status;
    document.getElementById('executionStatus').className = `status-${getStatusClass(status)}`;

    // 更新命令显示，使用代码样式
    const commandElement = document.getElementById('executionCommand');
    commandElement.textContent = command;
    commandElement.className = 'command-text';
    if (command !== '-') {
        commandElement.classList.add('has-command');
    }

    document.getElementById('startTime').textContent = startTime;

    if (reportStatus !== '-') {
        document.getElementById('reportLink').textContent = reportStatus;
    }
}

// 获取状态对应的CSS类名
function getStatusClass(status) {
    switch(status) {
        case '等待执行': return 'waiting';
        case '正在执行': return 'running';
        case '执行完成': return 'completed';
        case '已停止': return 'stopped';
        default: return 'waiting';
    }
}

// 重置UI状态
function resetUI() {
    document.getElementById('executeBtn').disabled = false;
    document.getElementById('executeBtn').textContent = '开始执行测试';
}

// 显示消息
function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = message;

    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        z-index: 1000;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    `;

    const colors = {
        info: '#3498db',
        success: '#27ae60',
        warning: '#f39c12',
        error: '#e74c3c'
    };
    messageDiv.style.backgroundColor = colors[type] || colors.info;

    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}
</script>

<style>
.execution-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.execution-form {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    background-color: #fff;
    transition: border-color 0.3s;
}

.form-group select:focus {
    border-color: #4a90e2;
    outline: none;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
}

.form-hint {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.btn-small {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-active {
    background-color: #28a745 !important;
}

.execution-info {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
}

.info-item {
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    min-height: 70px;
    justify-content: center;
}

.info-item label {
    font-weight: bold;
    color: #495057;
    margin-bottom: 5px;
    font-size: 14px;
}

.info-item span {
    word-break: break-all;
    overflow-wrap: break-word;
    line-height: 1.4;
}

/* 状态样式 */
.status-waiting {
    color: #6c757d;
    font-weight: 500;
}

.status-running {
    color: #007bff;
    font-weight: 500;
}

.status-completed {
    color: #28a745;
    font-weight: 500;
}

.status-stopped {
    color: #dc3545;
    font-weight: 500;
}

/* 命令文本样式 */
.command-text {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    background-color: #f1f3f4;
    padding: 8px;
    border-radius: 4px;
    border-left: 3px solid #4a90e2;
    overflow-x: auto;
    white-space: nowrap;
}

.command-text.has-command {
    background-color: #f8f9fa;
    color: #333;
}

.report-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}

.report-link:hover {
    text-decoration: underline;
}

.execution-log {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.log-controls {
    display: flex;
    gap: 8px;
}

.log-output {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
    white-space: pre-wrap;
    line-height: 1.4;
}

.log-placeholder {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 2rem;
}

.log-entry {
    margin-bottom: 2px;
    padding: 2px 0;
}

.log-time {
    color: #6a9955;
}

.log-level {
    font-weight: bold;
    margin: 0 4px;
}

.level-info {
    color: #569cd6;
}

.level-debug {
    color: #ce9178;
}

.level-warning {
    color: #ffc107;
}

.level-error {
    color: #f44747;
}

.level-critical {
    color: #f44747;
    font-weight: bold;
}

.log-name {
    color: #4ec9b0;
    margin: 0 4px;
}

.log-content {
    color: #d4d4d4;
}

.log-info {
    color: #d4d4d4;
}

.log-success {
    color: #28a745;
}

.log-warning {
    color: #ffc107;
}

.log-error {
    color: #dc3545;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

.message {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 4px;
    color: white;
    z-index: 1000;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.message-info {
    background-color: #3498db;
}

.message-success {
    background-color: #27ae60;
}

.message-warning {
    background-color: #f39c12;
}

.message-error {
    background-color: #e74c3c;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .execution-page {
        padding: 10px;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }

    .log-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .button-group {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}