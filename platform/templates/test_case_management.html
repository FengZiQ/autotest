{% extends "base.html" %}

{% block content %}
<div class="management-page">
    <h2>测试用例管理</h2>

    <!-- Toast 提示容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="form-section">
        <h3>新增测试用例</h3>
        <form id="testCaseForm">
            <div class="form-group">
                <label for="testProject">测试项目:</label>
                <select id="testProject" name="testProject" required>
                    <option value="">请选择测试项目</option>
                    <option value="Android">Android</option>
                    <option value="API">API</option>
                </select>
                <div class="form-hint">选择测试项目分类</div>
            </div>

            <div class="form-group">
                <label for="caseName">用例名称:</label>
                <input type="text" id="caseName" name="caseName" required placeholder="例如: login_success">
                <div class="form-hint">不需要包含.json后缀</div>
            </div>

            <div class="form-group">
                <label for="caseData">用例数据 (JSON格式):</label>
                <textarea id="caseData" name="caseData" rows="15" required placeholder='{"key": "value"}'></textarea>
                <div class="form-hint">请输入有效的JSON格式数据</div>
                <button type="button" id="formatJSON" class="btn btn-small">格式化JSON</button>
            </div>

            <button type="submit" class="btn btn-primary" id="saveButton">保存用例</button>
        </form>
    </div>

    <div class="test-plans-section">
        <h3>测试项目与用例</h3>

        {% if test_plans %}
            <div class="test-plans-container">
                {% for plan_name, cases in test_plans.items() %}
                <div class="test-plan-card">
                    <div class="test-plan-header">
                        <h4>{{ plan_name }} ({{ cases|length }} 个用例)</h4>
                        <button class="btn btn-small" onclick="togglePlan('{{ plan_name }}')">展开/收起</button>
                    </div>

                    <div class="cases-list" id="cases-{{ plan_name }}" style="display: none;">
                        {% for case in cases %}
                        <div class="case-item">
                            <span class="case-name">{{ case }}</span>
                            <div class="case-actions">
                                <button class="btn btn-small btn-edit" onclick="loadCase('{{ plan_name }}', '{{ case }}')">编辑</button>
                                <button class="btn btn-small btn-danger" onclick="deleteCase('{{ plan_name }}', '{{ case }}')">删除</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <p>暂无测试用例，请创建第一个测试用例</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
// 防止重复提交标志
let isSubmitting = false;
let formInitialized = false;

// 初始化事件监听 - 使用一次性初始化
function initializeForm() {
    if (formInitialized) return;

    const form = document.getElementById('testCaseForm');
    const formatBtn = document.getElementById('formatJSON');
    const caseData = document.getElementById('caseData');

    // 移除可能存在的旧监听器
    form.removeEventListener('submit', handleSubmit);
    formatBtn.removeEventListener('click', formatJSON);
    caseData.removeEventListener('input', validateJSON);

    // 添加新监听器
    form.addEventListener('submit', handleSubmit, { once: false });
    formatBtn.addEventListener('click', formatJSON, { once: false });
    caseData.addEventListener('input', validateJSON, { once: false });

    formInitialized = true;
    console.log('表单事件监听器已初始化');
}

// DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
});

// 如果页面是动态加载的，也重新初始化
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeForm);
} else {
    initializeForm();
}

// 处理表单提交 - 使用更严格的防止重复提交
async function handleSubmit(e) {
    e.preventDefault();
    e.stopPropagation(); // 阻止事件冒泡
    e.stopImmediatePropagation(); // 阻止其他相同类型的事件

    console.log('表单提交处理开始, isSubmitting:', isSubmitting);

    // 防止重复提交
    if (isSubmitting) {
        console.log('阻止重复提交');
        showToast('请勿重复提交', 'warning');
        return false;
    }

    // 设置提交状态
    isSubmitting = true;
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.textContent;
    saveButton.textContent = '保存中...';
    saveButton.disabled = true;

    const testProject = document.getElementById('testProject').value;
    const caseName = document.getElementById('caseName').value.trim();
    const caseData = document.getElementById('caseData').value.trim();

    // 验证输入
    if (!testProject) {
        showToast('请选择测试项目', 'warning');
        resetSubmitState(saveButton, originalText);
        return false;
    }

    if (!caseName) {
        showToast('请输入用例名称', 'warning');
        resetSubmitState(saveButton, originalText);
        return false;
    }

    if (!caseData) {
        showToast('请输入用例数据', 'warning');
        resetSubmitState(saveButton, originalText);
        return false;
    }

    // 验证JSON格式
    if (!isValidJSON(caseData)) {
        showToast('用例数据必须是有效的JSON格式', 'error');
        resetSubmitState(saveButton, originalText);
        return false;
    }

    try {
        console.log('开始API调用');
        const response = await fetch('/api/test-cases', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                test_project: testProject,
                case_name: caseName,
                case_data: caseData
            })
        });

        const data = await response.json();
        console.log('API响应:', data);

        if (data.success) {
            showToast('保存成功！', 'success');
            // 清空表单
            document.getElementById('testCaseForm').reset();
            clearValidation();
            // 刷新页面
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('保存失败: ' + data.message, 'error');
            resetSubmitState(saveButton, originalText);
        }
    } catch (error) {
        console.error('保存失败:', error);
        showToast('保存失败，请检查网络连接', 'error');
        resetSubmitState(saveButton, originalText);
    }

    return false; // 防止默认表单提交行为
}

// 重置提交状态
function resetSubmitState(button, originalText) {
    setTimeout(() => {
        isSubmitting = false;
        button.textContent = originalText;
        button.disabled = false;
        console.log('提交状态已重置');
    }, 1000);
}

// JSON验证函数
function isValidJSON(str) {
    try {
        JSON.parse(str);
        return true;
    } catch (e) {
        return false;
    }
}

// 格式化JSON
function formatJSON() {
    const textarea = document.getElementById('caseData');
    try {
        const obj = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(obj, null, 4);
        showValidationState('valid', 'JSON格式正确');
    } catch (e) {
        showValidationState('invalid', 'JSON格式错误，无法格式化');
    }
}

// JSON实时验证
function validateJSON(event) {
    const textarea = event.target;
    const value = textarea.value.trim();

    if (value === '') {
        clearValidation();
        return;
    }

    if (isValidJSON(value)) {
        showValidationState('valid', 'JSON格式正确');
    } else {
        showValidationState('invalid', 'JSON格式错误');
    }
}

// 清除验证状态
function clearValidation() {
    const textarea = document.getElementById('caseData');
    const hint = document.querySelector('.json-validation-hint');

    if (textarea) {
        textarea.classList.remove('valid', 'invalid');
    }
    if (hint) {
        hint.remove();
    }
}

// 显示验证状态
function showValidationState(state, message) {
    const textarea = document.getElementById('caseData');
    let hint = document.querySelector('.json-validation-hint');

    // 移除现有状态类
    textarea.classList.remove('valid', 'invalid');
    textarea.classList.add(state);

    // 创建或更新提示信息
    if (!hint) {
        hint = document.createElement('div');
        hint.className = 'json-validation-hint';
        textarea.parentNode.appendChild(hint);
    }

    hint.textContent = message;
    hint.className = `json-validation-hint ${state}`;
}

// 切换测试项目显示
function togglePlan(planName) {
    const casesList = document.getElementById(`cases-${planName}`);
    if (casesList.style.display === 'none') {
        casesList.style.display = 'block';
    } else {
        casesList.style.display = 'none';
    }
}

// 加载用例进行编辑
async function loadCase(testProject, caseName) {
    try {
        // 移除.json后缀
        const pureCaseName = caseName.replace('.json', '');

        const response = await fetch(`/api/test-cases/${testProject}/${pureCaseName}`);
        const data = await response.json();

        if (data.success) {
            // 填充表单
            document.getElementById('testProject').value = testProject;
            document.getElementById('caseName').value = pureCaseName;
            document.getElementById('caseData').value = data.data;

            // 滚动到表单
            document.querySelector('.form-section').scrollIntoView({
                behavior: 'smooth'
            });

            // 更新按钮文本
            document.querySelector('button[type="submit"]').textContent = '更新用例';

            showToast(`已加载用例: ${caseName}，请修改后点击"更新用例"保存`, 'info');
        } else {
            showToast('加载失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('加载用例失败:', error);
        showToast('加载失败，请检查网络连接', 'error');
    }
}

// 删除用例
function deleteCase(testProject, caseName) {
    if (!confirm(`确定要删除用例 "${caseName}" 吗？此操作不可恢复。`)) {
        return;
    }
    // 调用后端删除接口
    fetch(`/api/test-cases/${testProject}/${caseName}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('删除成功', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('删除失败: ' + data.message, 'error');
        }
    });
}

// 显示Toast提示
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // 自动移除
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>

<style>
.test-plans-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.test-plan-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.test-plan-header {
    background: #f8f9fa;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
}

.test-plan-header h4 {
    margin: 0;
    color: #495057;
}

.cases-list {
    padding: 15px;
    background: white;
}

.case-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.case-item:last-child {
    border-bottom: none;
}

.case-name {
    font-weight: 500;
    color: #333;
}

.case-actions {
    display: flex;
    gap: 8px;
}

.btn-edit {
    background-color: #17a2b8;
}

.btn-edit:hover {
    background-color: #138496;
}

.btn-danger {
    background-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    background: #f8f9fa;
    border-radius: 8px;
}

.json-validation-hint {
    margin-top: 5px;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 3px;
}

.json-validation-hint.valid {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.json-validation-hint.invalid {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

textarea.valid {
    border-color: #28a745;
}

textarea.invalid {
    border-color: #dc3545;
}

/* Toast 样式 */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    min-width: 300px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideIn 0.3s ease-out;
}

.toast-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
}

.toast-message {
    flex: 1;
    margin-right: 10px;
}

.toast-close {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
}

.toast-close:hover {
    opacity: 1;
}

.toast-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.toast-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.toast-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.toast-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* 按钮禁用状态 */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* 防止表单重复提交的额外样式 */
#testCaseForm {
    position: relative;
}

#saveButton:disabled::after {
    content: ' (提交中...)';
    font-size: 0.9em;
    opacity: 0.8;
}
</style>
{% endblock %}